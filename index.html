<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:300,600" />
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/virtualJoystick.css">
		<script type="text/javascript" src="js/virtualJoystick.js"></script>
		<script type="text/javascript" src="js/GameClient.js"></script>
	</head>
	<body>

		<canvas id="canvas"></canvas>
		
		<div class="dashboardContainer">
			<div class="container card-list">
				<div class="card blue">
					<div class="title">Statistics 1</div>
					<div class="value">89</div>
					<div class="stat"><b>13</b>% increase</div>
				</div>
				<div class="card green">
					<div class="title">Statistics 2</div>
					<div class="value">5,990</div>
					<div class="stat"><b>4</b>% increase</div>
				</div>
				<div class="card orange">
					<div class="title">Statistics 3</div>
					<div class="value">80,990</div>
					<div class="stat"><b>13</b>% decrease</div>
				</div>
				<div class="card red">
					<div class="title">Statistics 4</div>
					<div class="value">3</div>
					<div class="stat"><b>13</b>% decrease</div>
				</div>

				<div class="buttonContainer">
					<button class="blue" onclick="pause()">Stop RAF</button>
					<button class="blue" id="home">Go Home</button>
					<button class="blue" id="random">Random</button>
					<button class="blue" id="formation">Formation</button>
				</div>

			</div>

			<div class="container projects">
				<div class="projects-inner">
					<header class="projects-header">
						<div class="title">Super Simple gameserver ver. 0.0.0 alpha</div>
						<div class="count">| If nothing happens open 2 windows with the same URL</div>
					</header>
					<table class="projects-table">
						<thead>
							<tr>
								<th>State</th>
								<th>Data</th>
								<th>Status</th>
							</tr>
						</thead>
						<tr>
							<td>
								<p id="state">waiting...</p>
								<p id="substate">idle</p>
							</td>
							<td>
								<p id="websocket-id">websocket id</p>
								<p class="danger-text">websocket id</p>
							</td>
							<td class="status"><span id="lobby-id" class="status-text status-orange">lobby id</span></td>
						</tr>
						<tr class="danger-item">
							<td>
								<p id="team">team</p>
								<p>Team name</p>
							</td>
							<td>
								<p id="position.x">destination x</p>
								<p class="danger-text">destination x</p>
							</td>
							<td class="status"><span id="action" class="status-text status-red">action</span></td>
						</tr>
						<tr>
							<td>
								<p id="playerIndex">New Dashboard</p>
								<p>last player id processed</p>
							</td>
							<td>
								<p id="position.y">destination y</p>
								<p class="danger-text">destination y</p>
							</td>
							<td class="status"><span id="serverState" class="status-text status-blue">server state</span></td>
						</tr>
					</table>
				</div>
			</div>
		</div>

		<div id="grids" class="one0">

			<h1>Players State</h1>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>			

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>			

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>		

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>

			<div class="subgrid">
				<div class="inside red redTeam">block</div>
				<div class="inside blue blueTeam">block</div>
			</div>	

		</div>

		<div id="joystickStatic"></div>
	    <div class="virtualButton" id="buttonShoot">Shoot</div>
	    <div class="virtualButton" id="buttonReset">Reset</div>

		<script>

		</script>

	</body>

	<script type="text/javascript" src="js/Pitch.js"></script>
	<script type="text/javascript" src="js/StateClient.js"></script>
	<script type="text/javascript" src="modules/Vec2.js"></script>
	<script type="text/javascript" src="modules/Boid.js"></script>

	<script>

		let gameClient = new GameClient();

	</script>

	<script type="text/javascript">
		"use strict";
		let RAF;
		function pause(){
			cancelAnimationFrame( RAF );
		};

		let urlParams = new URLSearchParams( window.location.search );
		let id = urlParams.get( 'id' );

		let HOST = location.origin.replace( /^http/, 'ws' );

		// connecting to the web server
		let socket = new WebSocket( HOST + '/?serverState=onetoone', 'echo-protocol' );
		//var socket = new WebSocket( 'ws://localhost:4000/' + id, 'echo-protocol' ); 

		// listening for server response
		socket.onmessage = function ( message ) { 

			let obj = JSON.parse( message.data );

			if( "state" in obj ) {

				switch( obj.state ) {
					
					case "wait":
						break;

					case "connected":
						document.getElementById( "state" ).innerText = "Connected";
						document.getElementById( "substate" ).innerText = "waiting for opponent...";
						document.getElementById( "websocket-id" ).innerText = obj.websocket;
						break;

					case "start":
						gameClient.init( obj.lobby, obj.team, obj.schemaRedTeam, obj.schemaBlueTeam );
						document.getElementById( "team" ).innerText = obj.team;
						document.getElementById( "state" ).innerText = "Opponent found";
						document.getElementById( "substate" ).innerText = "Game started";
						document.getElementById( "lobby-id" ).innerText = obj.lobby;
						break;

					case "update":
						gameClient.updatePlayer( obj );
						document.getElementById( "action" ).innerText = obj.state;
						document.getElementById( "serverState" ).innerText = obj.state;
						document.getElementById( "position.x" ).innerText = obj.player.destination.x;
						document.getElementById( "position.y" ).innerText = obj.player.destination.y;
						document.getElementById( "playerIndex" ).innerText = obj.player.index;
						break;

					case "controlled":
					case "dropControl":
						if ( obj.state == "dropControl" ){
							document.getElementById( obj.player.index ).classList.remove( "green" );
						};
						gameClient.updateControlledPlayer( obj );
						document.getElementById( "action" ).innerText = obj.state;
						document.getElementById( "serverState" ).innerText = obj.state;
						document.getElementById( "position.x" ).innerText = obj.player.position.x;
						document.getElementById( "position.y" ).innerText = obj.player.position.y;
						document.getElementById( "playerIndex" ).innerText = obj.player.index;
						break;

					case "reset":
						gameClient.reset();
						document.getElementById( "state" ).innerText = "Reset Connection";
						document.getElementById( "substate" ).innerText = "waiting for opponent...";
						document.getElementById( "websocket-id" ).innerText = obj.websocket;
						break;

					default:
				
				};
			
			};

		};

		// listening for any socket error
		socket.onerror = function ( error ) { 
			console.log( 'WebSocket error: ' + error );
		};

		function sendMessage( data ) {
			socket.send( data ); 
		};

	</script>

	<script>

		/*
		* listener
		*/
		Array.from( document.getElementsByClassName( "redTeam" ) ).forEach( function( element, index ) {
		
			element.id = index;
		});

		Array.from( document.getElementsByClassName( "blueTeam" ) ).forEach( function( element, index ) {
		
			element.id = index + 11;
		});


		Array.from( document.getElementsByClassName( "inside" ) ).forEach( function( element, index ) {
		
			element.addEventListener( 'click', function( event ){

				if ( gameClient.players.length < 1 || !element.classList.contains( gameClient.team ) ) return false;

				//drop if already controlled
				for( var t = 0; t < gameClient.players.length; t++ ) {
					
					if ( gameClient.players[ t ].state.getCurrentState() == "controlled" && 
						gameClient.players[ t ].team == gameClient.team ){

						gameClient.players[ t ].state.popState();
						gameClient.players[ t ].state.pushState( "dropControl" );
						break;

					};
				
				};

				if ( event.srcElement.id != t ) {

					gameClient.players[ event.srcElement.id ].state.popState();
					gameClient.players[ event.srcElement.id ].state.pushState( "getControl" );
				
				};

			});

			element.addEventListener( 'mouseover', function( event ){
				
				event.srcElement.classList.add( "orange" );

				if ( gameClient.players.length < 1 ) return false;

				gameClient.players[ event.srcElement.id ].color = "#ffffff";
			
			});

			element.addEventListener( 'mouseout', function( event ){

				event.srcElement.classList.remove( "orange" );
				
				if ( gameClient.players.length < 1 ) return false;

				if ( gameClient.players[ event.srcElement.id ].team == "redTeam" ){

					gameClient.players[ event.srcElement.id ].color = "#ff0000";
				
				} else {
				
					gameClient.players[ event.srcElement.id ].color = "#0000ff";
				
				};
			
			});

		});


		function getRandomInt( min, max ){

			return Math.random() * ( max - min ) + min;
		};

		document.getElementById( "home" ).addEventListener( "click", function(){

			for ( let i = 0; i < gameClient.playerNum; i++ ){

				var distribute = function( val, max, min ) { return ( val - min ) / ( max - min ); }; //normalize
				var value = distribute( i, gameClient.playerNum, 0 ) * 18;
				var row = parseInt( value / 6 );
				var column = value % 6;      
				gameClient.players[i].boid.destination.x = column * 150 + getRandomInt( 60,90 ); 
				gameClient.players[i].boid.destination.y = row * 187.5 + getRandomInt( 90, 120 );

			};

		});

		document.getElementById( "random" ).addEventListener( "click", function(){

			for ( var i = 0; i < gameClient.playerNum; i++ ){

				gameClient.players[i].boid.destination.x = getRandomInt( 60, 960 );
				gameClient.players[i].boid.destination.y = getRandomInt( 40, 580 );

			};

		});

		document.getElementById( "formation" ).addEventListener( "click", function(){

			console.log( "formation" );

		});

	</script>

<html>

